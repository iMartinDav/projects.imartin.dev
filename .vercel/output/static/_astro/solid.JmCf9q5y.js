const l={context:void 0,registry:void 0,getContextId(){return H(this.context.count)},getNextContextId(){return H(this.context.count++)}};function H(t){const e=String(t),s=e.length-1;return l.context.id+(s?String.fromCharCode(96+s):"")+e}function g(t){l.context=t}function q(){return{...l.context,id:l.getNextContextId(),count:0}}const tt=(t,e)=>t===e,m={equals:tt};let M=B;const p=1,E=2,V={owned:null,cleanups:null,context:null,owner:null};var o=null;let L=null,et=null,i=null,c=null,a=null,N=0;function nt(t,e){const s=i,n=o,r=t.length===0,u=e===void 0?n:e,f=r?V:{owned:null,cleanups:null,context:u?u.context:null,owner:u},$=r?t:()=>t(()=>h(()=>U(f)));o=f,i=null;try{return C($,!0)}finally{i=s,o=n}}function R(t,e){e=e?Object.assign({},m,e):m;const s={value:t,observers:null,observerSlots:null,comparator:e.equals||void 0},n=r=>(typeof r=="function"&&(r=r(s.value)),z(s,r));return[W.bind(s),n]}function st(t,e,s){const n=T(t,e,!1,p);S(n)}function rt(t,e,s){M=ht;const n=T(t,e,!1,p),r=A&&Q(A);r&&(n.suspense=r),n.user=!0,a?a.push(n):S(n)}function w(t,e,s){s=s?Object.assign({},m,s):m;const n=T(t,e,!0,0);return n.observers=null,n.observerSlots=null,n.comparator=s.equals||void 0,S(n),W.bind(n)}function h(t){if(i===null)return t();const e=i;i=null;try{return t()}finally{i=e}}function bt(t){rt(()=>h(t))}function ut(t){return o===null||(o.cleanups===null?o.cleanups=[t]:o.cleanups.push(t)),t}function ot(){return o}function lt(t){a.push.apply(a,t),t.length=0}function G(t,e){const s=Symbol("context");return{id:s,Provider:dt(s),defaultValue:t}}function Q(t){let e;return o&&o.context&&(e=o.context[t.id])!==void 0?e:t.defaultValue}function it(t){const e=w(t),s=w(()=>P(e()));return s.toArray=()=>{const n=s();return Array.isArray(n)?n:n!=null?[n]:[]},s}let A;function ct(){return A||(A=G())}function W(){if(this.sources&&this.state)if(this.state===p)S(this);else{const t=c;c=null,C(()=>F(this),!1),c=t}if(i){const t=this.observers?this.observers.length:0;i.sources?(i.sources.push(this),i.sourceSlots.push(t)):(i.sources=[this],i.sourceSlots=[t]),this.observers?(this.observers.push(i),this.observerSlots.push(i.sources.length-1)):(this.observers=[i],this.observerSlots=[i.sources.length-1])}return this.value}function z(t,e,s){let n=t.value;return(!t.comparator||!t.comparator(n,e))&&(t.value=e,t.observers&&t.observers.length&&C(()=>{for(let r=0;r<t.observers.length;r+=1){const u=t.observers[r],f=L&&L.running;f&&L.disposed.has(u),(f?!u.tState:!u.state)&&(u.pure?c.push(u):a.push(u),u.observers&&J(u)),f||(u.state=p)}if(c.length>1e6)throw c=[],new Error},!1)),e}function S(t){if(!t.fn)return;U(t);const e=N;ft(t,t.value,e)}function ft(t,e,s){let n;const r=o,u=i;i=o=t;try{n=t.fn(e)}catch(f){return t.pure&&(t.state=p,t.owned&&t.owned.forEach(U),t.owned=null),t.updatedAt=s+1,K(f)}finally{i=u,o=r}(!t.updatedAt||t.updatedAt<=s)&&(t.updatedAt!=null&&"observers"in t?z(t,n):t.value=n,t.updatedAt=s)}function T(t,e,s,n=p,r){const u={fn:t,state:n,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:o,context:o?o.context:null,pure:s};return o===null||o!==V&&(o.owned?o.owned.push(u):o.owned=[u]),u}function k(t){if(t.state===0)return;if(t.state===E)return F(t);if(t.suspense&&h(t.suspense.inFallback))return t.suspense.effects.push(t);const e=[t];for(;(t=t.owner)&&(!t.updatedAt||t.updatedAt<N);)t.state&&e.push(t);for(let s=e.length-1;s>=0;s--)if(t=e[s],t.state===p)S(t);else if(t.state===E){const n=c;c=null,C(()=>F(t,e[0]),!1),c=n}}function C(t,e){if(c)return t();let s=!1;e||(c=[]),a?s=!0:a=[],N++;try{const n=t();return at(s),n}catch(n){s||(a=null),c=null,K(n)}}function at(t){if(c&&(B(c),c=null),t)return;const e=a;a=null,e.length&&C(()=>M(e),!1)}function B(t){for(let e=0;e<t.length;e++)k(t[e])}function ht(t){let e,s=0;for(e=0;e<t.length;e++){const n=t[e];n.user?t[s++]=n:k(n)}if(l.context){if(l.count){l.effects||(l.effects=[]),l.effects.push(...t.slice(0,s));return}else l.effects&&(t=[...l.effects,...t],s+=l.effects.length,delete l.effects);g()}for(e=0;e<s;e++)k(t[e])}function F(t,e){t.state=0;for(let s=0;s<t.sources.length;s+=1){const n=t.sources[s];if(n.sources){const r=n.state;r===p?n!==e&&(!n.updatedAt||n.updatedAt<N)&&k(n):r===E&&F(n,e)}}}function J(t){for(let e=0;e<t.observers.length;e+=1){const s=t.observers[e];s.state||(s.state=E,s.pure?c.push(s):a.push(s),s.observers&&J(s))}}function U(t){let e;if(t.sources)for(;t.sources.length;){const s=t.sources.pop(),n=t.sourceSlots.pop(),r=s.observers;if(r&&r.length){const u=r.pop(),f=s.observerSlots.pop();n<r.length&&(u.sourceSlots[f]=n,r[n]=u,s.observerSlots[n]=f)}}if(t.owned){for(e=t.owned.length-1;e>=0;e--)U(t.owned[e]);t.owned=null}if(t.cleanups){for(e=t.cleanups.length-1;e>=0;e--)t.cleanups[e]();t.cleanups=null}t.state=0}function pt(t){return t instanceof Error?t:new Error(typeof t=="string"?t:"Unknown error",{cause:t})}function K(t,e=o){throw pt(t)}function P(t){if(typeof t=="function"&&!t.length)return P(t());if(Array.isArray(t)){const e=[];for(let s=0;s<t.length;s++){const n=P(t[s]);Array.isArray(n)?e.push.apply(e,n):e.push(n)}return e}return t}function dt(t,e){return function(n){let r;return st(()=>r=h(()=>(o.context={...o.context,[t]:n.value},it(()=>n.children))),void 0),r}}let X=!1;function vt(){X=!0}function gt(t,e){if(X&&l.context){const s=l.context;g(q());const n=h(()=>t(e||{}));return g(s),n}return h(()=>t(e||{}))}const wt=t=>`Stale read from <${t}>.`;function yt(t){const e=t.keyed,s=w(()=>t.when,void 0,{equals:(n,r)=>e?n===r:!n==!r});return w(()=>{const n=s();if(n){const r=t.children;return typeof r=="function"&&r.length>0?h(()=>r(e?n:()=>{if(!h(s))throw wt("Show");return t.when})):r}return t.fallback},void 0,void 0)}const xt=G();function St(t){let e=0,s,n,r,u,f;const[$,j]=R(!1),Y=ct(),b={increment:()=>{++e===1&&j(!0)},decrement:()=>{--e===0&&j(!1)},inFallback:$,effects:[],resolved:!1},Z=ot();if(l.context&&l.load){const v=l.getContextId();let x=l.load(v);if(x&&(typeof x!="object"||x.status!=="success"?r=x:l.gather(v)),r&&r!=="$$f"){const[I,y]=R(void 0,{equals:!1});u=I,r.then(()=>{if(l.done)return y();l.gather(v),g(n),y(),g()},O=>{f=O,y()})}}const D=Q(xt);D&&(s=D.register(b.inFallback));let d;return ut(()=>d&&d()),gt(Y.Provider,{value:b,get children(){return w(()=>{if(f)throw f;if(n=l.context,u)return u(),u=void 0;n&&r==="$$f"&&g();const v=w(()=>t.children);return w(x=>{const I=b.inFallback(),{showContent:y=!0,showFallback:O=!0}=s?s():{};if((!I||r&&r!=="$$f")&&y)return b.resolved=!0,d&&d(),d=n=r=void 0,lt(b.effects),v();if(O)return d?x:nt(_=>(d=_,n&&(g({id:n.id+"F",count:0}),n=void 0),t.fallback),Z)})})}})}export{yt as S,gt as a,St as b,R as c,st as d,nt as e,vt as f,ut as g,bt as o,l as s,h as u};
